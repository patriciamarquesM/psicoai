<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>PsicoAi ‚Äî Prontu√°rio & An√°lise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonte (Inter) e tema clean -->
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Navega√ß√£o SPA simples */
    .topnav{display:flex; gap:10px; margin-left:12px}
    .navlink{padding:6px 10px; border-radius:8px; color:var(--muted); text-decoration:none; border:1px solid transparent}
    .navlink.active{color:var(--text); border-color:var(--border); background:var(--surface)}
    .navlink:hover{color:var(--primary); border-color:var(--primary)}
    .view{display:none}
    .view.active{display:block}
  </style>
</head>
<body>

  <!-- TOPBAR com navega√ß√£o entre telas -->
  <header class="topbar">
    <div class="brand"><h1>PsicoAi</h1></div>

    <nav class="topnav" id="mainNav">
      <a href="#/dashboard"     class="navlink" data-view="dashboard">Dashboard</a>
      <a href="#/pacientes"     class="navlink" data-view="pacientes">Pacientes</a>
      <a href="#/prontuario"    class="navlink" data-view="prontuario">Prontu√°rio</a>
      <a href="#/transcricao"   class="navlink" data-view="transcricao">Transcri√ß√£o</a>
      <a href="#/relatorios"    class="navlink" data-view="relatorios">Relat√≥rios</a>
      <a href="#/configuracoes" class="navlink" data-view="configuracoes">Configura√ß√µes</a>
    </nav>

    <button id="themeToggle" class="icon-btn" title="Claro/Escuro">üåì</button>
  </header>

  <!-- CONTAINER -->
  <main class="container">

    <!-- ============ VIEW: DASHBOARD ============ -->
    <section class="view panel" data-view="dashboard">
      <h2>Resumo</h2>
      <div class="row" style="gap:12px; flex-wrap:wrap">
        <div class="kpi"><div class="kpi-num" id="kpiPatients">‚Äî</div><div class="kpi-label">Pacientes</div></div>
        <div class="kpi"><div class="kpi-num" id="kpiRecords">‚Äî</div><div class="kpi-label">Sess√µes</div></div>
        <div class="kpi"><div class="kpi-num" id="kpiThisMonth">‚Äî</div><div class="kpi-label">Min (m√™s)</div></div>
      </div>
      <div class="row" style="margin-top:10px">
        <a class="btn primary" href="#/pacientes"  data-jump="pacientes">Novo paciente</a>
        <a class="btn"          href="#/transcricao" data-jump="transcricao">Nova transcri√ß√£o</a>
        <a class="btn"          href="#/prontuario"  data-jump="prontuario">Abrir prontu√°rio</a>
        <a class="btn"          href="#/relatorios"  data-jump="relatorios">Gerar relat√≥rio</a>
      </div>
    </section>

    <style>
      .kpi{min-width:160px; border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--surface); box-shadow:var(--shadow)}
      .kpi-num{font-size:28px; font-weight:700}
      .kpi-label{color:var(--muted)}
    </style>

    <!-- ============ VIEW: PACIENTES ============ -->
    <section class="view panel" data-view="pacientes">
      <h2>Pacientes</h2>
      <div class="grid">
        <section class="panel" style="grid-column: span 6">
          <h3 style="margin:0 0 8px">Cadastrar / Editar</h3>
          <form id="patientForm" autocomplete="off">
            <div class="grid">
              <label>Nome <input name="nome" required /></label>
              <label>CPF <input name="cpf" inputmode="numeric" placeholder="000.000.000-00" required /></label>
              <label>Data de nascimento <input name="dob" type="date" required /></label>
              <label>E-mail <input name="email" type="email" required /></label>
              <label class="full">Endere√ßo <input name="endereco" /></label>
            </div>
            <div class="row" style="margin-top:8px">
              <button class="btn primary" type="submit">Salvar</button>
              <button class="btn" type="reset" id="resetForm">Limpar</button>
              <span class="muted small">CPF √© armazenado como <em>hash</em>.</span>
            </div>
            <input type="hidden" name="id" />
          </form>
        </section>

        <section class="panel" style="grid-column: span 6">
          <h3 style="margin:0 0 8px">Lista</h3>
          <input id="search" placeholder="buscar por nome ou e-mail" />
          <div id="patientList" class="list" style="margin-top:8px"></div>
        </section>
      </div>
    </section>

    <!-- ============ VIEW: PRONTU√ÅRIO ============ -->
    <section class="view panel" data-view="prontuario">
      <h2>Prontu√°rio</h2>
      <div class="row">
        <label class="full">Paciente
          <select id="selPatient"></select>
        </label>
        <label>De: <input id="filterFrom" type="date"></label>
        <label>At√©: <input id="filterTo" type="date"></label>
        <button id="applyFilter" class="btn">Aplicar</button>
        <button id="clearFilter" class="btn">Limpar</button>
        <span style="flex:1"></span>
        <!-- bot√£o mantido para compatibilidade; redireciona para Transcri√ß√£o -->
        <button id="openTranscription" class="btn primary" data-jump="transcricao">Nova transcri√ß√£o</button>
      </div>

      <div id="recordView" class="record-view empty" style="margin-top:10px">
        <p>Selecione um paciente para visualizar o prontu√°rio.</p>
      </div>

      <section class="panel" style="margin-top:16px">
        <h2>M√≥dulo Inteligente (Resumo & Teorias)</h2>
        <div id="analysisPanel" class="analysis"></div>
      </section>

      <section class="panel" style="margin-top:16px">
        <h2>Insights & Gr√°ficos</h2>
        <div id="chartsPanel">
          <div class="box">
            <strong>Dura√ß√£o total por m√™s (min)</strong>
            <svg id="chartLine" viewBox="0 0 600 220" style="width:100%;height:auto"></svg>
          </div>
          <div class="box" style="margin-top:12px">
            <strong>Termos mais frequentes</strong>
            <svg id="chartBars" viewBox="0 0 600 260" style="width:100%;height:auto"></svg>
          </div>
        </div>
      </section>
    </section>

    <!-- ============ VIEW: TRANSCRI√á√ÉO ============ -->
    <section class="view panel" data-view="transcricao">
      <h2>Transcri√ß√£o</h2>
      <div class="grid">
        <label class="full">Paciente
          <select id="selPatientTx"></select>
        </label>
        <label class="full">Arquivo de √°udio
          <input id="audioFile" type="file" accept="audio/*,video/mp4,video/m4a,video/*" />
        </label>
        <label class="full">Transcri√ß√£o
          <textarea id="pastedTranscript" rows="8" placeholder="A transcri√ß√£o aparecer√° aqui..."></textarea>
        </label>
      </div>

      <div class="row" style="margin-top:8px; gap:10px; align-items:center">
        <button id="btnTranscribeFile" class="btn">Transcrever arquivo (offline)</button>
        <span id="sttStatus" class="badge">modelo: n√£o carregado</span>
        <label><input id="sttEnhance" type="checkbox" checked> Melhorar √°udio</label>
        <label>Idioma:
          <select id="sttLang"><option value="pt" selected>PT</option><option value="es">ES</option><option value="en">EN</option></select>
        </label>
      </div>

      <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />

      <h3>Metadados</h3>
      <div class="grid">
        <label>Dura√ß√£o (min) <input id="sessDuration" type="number" min="0" step="5" placeholder="50" /></label>
        <label>Setting <input id="sessSetting" placeholder="presencial / remoto..." /></label>
        <label class="full">Interven√ß√µes <input id="sessInterv" placeholder="associa√ß√µes, interpreta√ß√µes..." /></label>
        <label class="full">CID-10 <input id="sessCID" placeholder="ex.: F32.1, F41.1" /></label>
        <label class="full">DSM-5 <input id="sessDSM" placeholder="ex.: 300.02, 296.32" /></label>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="saveTranscript" class="btn primary">Salvar no Prontu√°rio</button>
      </div>
    </section>

    <!-- ============ VIEW: RELAT√ìRIOS ============ -->
    <section class="view panel" data-view="relatorios">
      <h2>Relat√≥rios & Exporta√ß√µes</h2>
      <div class="row">
        <button id="exportJson" class="btn">Exportar JSON</button>
        <button id="exportCsvPatients" class="btn">CSV Pacientes</button>
        <button id="exportCsvRecords" class="btn">CSV Prontu√°rios</button>
        <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
        <button id="importJsonBtn" class="btn">Importar JSON</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="pdfReport" class="btn primary">PDF ‚Äî √öltima sess√£o (paciente atual)</button>
        <label>De: <input id="filterFrom" type="date"></label>
        <label>At√©: <input id="filterTo" type="date"></label>
        <button id="pdfReportPeriod" class="btn">PDF ‚Äî Por per√≠odo</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">Comparativo</span>
        <label>A De: <input id="compAFrom" type="date"></label>
        <label>A At√©: <input id="compATo" type="date"></label>
        <label>B De: <input id="compBFrom" type="date"></label>
        <label>B At√©: <input id="compBTo" type="date"></label>
        <button id="pdfReportCompare" class="btn">PDF ‚Äî A vs B</button>
      </div>
    </section>

    <!-- ============ VIEW: CONFIGURA√á√ïES ============ -->
    <section class="view panel" data-view="configuracoes">
      <h2>Configura√ß√µes Cl√≠nicas</h2>
      <div class="grid">
        <label>Nome do profissional
          <input id="clinicianName" placeholder="ex.: Dra. Maria Silva" />
        </label>
        <label>Registro (CRP/CRM)
          <input id="clinicianReg" placeholder="ex.: CRP 00/00000" />
        </label>
        <label class="full">Chave secreta (assinatura digital)
          <input id="signatureSecret" type="password" placeholder="Opcional ‚Äî fica s√≥ no seu navegador" />
        </label>
      </div>

      <h3>Campos cl√≠nicos customiz√°veis</h3>
      <div class="row">
        <input id="newFieldLabel" placeholder="ex.: Setting, Interven√ß√µes, Escalas..." />
        <button id="addField" class="btn">Adicionar</button>
      </div>
      <div id="customFieldsList" class="list" style="margin-top:8px"></div>

      <div class="row" style="margin-top:8px">
        <button id="saveSettings" class="btn primary">Salvar</button>
        <button id="resetSettings" class="btn">Restaurar padr√£o</button>
      </div>
    </section>

  </main>

  <!-- (Opcional) Modal original de transcri√ß√£o ‚Äî mantido por compatibilidade com components.js -->
  <div id="transcriptionModal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <header class="modal-header">
        <h3>Nova Transcri√ß√£o</h3>
        <button class="icon-btn" id="closeModal" aria-label="Fechar">‚úï</button>
      </header>
      <div class="modal-body"><p class="muted small">Use a tela <strong>Transcri√ß√£o</strong> no menu acima.</p></div>
      <footer class="modal-footer"><button id="cancelTranscript" class="btn">Fechar</button></footer>
    </div>
  </div>

  <!-- ===== Scripts ===== -->

  <!-- Tema claro/escuro persistente -->
  <script>
    (function(){
      const KEY='psicoai_theme';
      const html=document.documentElement;
      html.dataset.theme = localStorage.getItem(KEY) || 'light';
      document.getElementById('themeToggle')?.addEventListener('click', ()=>{
        const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
        html.dataset.theme = next; localStorage.setItem(KEY,next);
      });
    })();
  </script>

  <!-- Router SPA (troca de telas) + pequenos binds -->
  <script>
    (function(){
      const DEFAULT_VIEW = 'dashboard';
      function show(v){
        // ativa link
        document.querySelectorAll('.navlink').forEach(a=>{
          a.classList.toggle('active', a.dataset.view===v);
        });
        // alterna as views
        document.querySelectorAll('.view').forEach(sec=>{
          sec.classList.toggle('active', sec.dataset.view===v);
        });
        localStorage.setItem('psicoai_last_view', v);
        // atalhos de UX: se clicar "Nova transcri√ß√£o" dentro do prontu√°rio
        if(v==='transcricao'){
          // popular lista de pacientes na tela de transcri√ß√£o
          const KEY='psicoai_db_v1';
          try{
            const db = JSON.parse(localStorage.getItem(KEY)||'{}');
            const list = (db.patients||[]);
            const sel = document.getElementById('selPatientTx');
            if(sel && list.length){
              sel.innerHTML = list.map(p=>`<option value="${p.id}">${p.nome}</option>`).join('');
            }
          }catch(e){}
        }
        if(v==='dashboard'){
          // KPIs
          const KEY='psicoai_db_v1';
          try{
            const db = JSON.parse(localStorage.getItem(KEY)||'{}');
            const patients = db.patients||[];
            const records  = db.records ||[];
            const m = new Date().toISOString().slice(0,7);
            const minMonth = records.filter(r=> (r.createdAt||'').slice(0,7)===m)
                                    .reduce((s,r)=>s+(+r.duration||0),0);
            (document.getElementById('kpiPatients')||{}).textContent = patients.length;
            (document.getElementById('kpiRecords') ||{}).textContent  = records.length;
            (document.getElementById('kpiThisMonth')||{}).textContent = minMonth;
          }catch(e){}
        }
      }
      function currentView(){
        const h = location.hash.replace(/^#\//,'').trim();
        return h || localStorage.getItem('psicoai_last_view') || DEFAULT_VIEW;
      }
      window.addEventListener('hashchange', ()=>show(currentView()));
      document.addEventListener('click', (ev)=>{
        const j = ev.target.closest('[data-jump]');
        if(j){ ev.preventDefault(); location.hash = '/'+j.dataset.jump; }
      });
      // inicializa
      show(currentView());
    })();
  </script>

  <!-- Transcri√ß√£o offline (com NR + VAD + AGC + fallbacks) -->
  <script type="module" src="stt_offline.js?v=6"></script>

  <!-- M√≥dulos do app (j√° existentes) -->
  <script type="module" src="export.js"></script>
  <script type="module" src="report.js"></script>
  <script type="module" src="settings.js"></script>
  <script type="module" src="codes.js"></script>
  <script type="module" src="autocomplete.js"></script>
  <script type="module" src="charts.js"></script>
  <script type="module" src="components.js"></script>
  <script type="module" src="analysis.js"></script>
  <script type="module" src="speech.js"></script>
  <script type="module" src="db.js"></script>
  <script type="module" src="utils.js"></script>
  <script type="module" src="app.js"></script>

  <!-- Quickfix do cadastro (opcional; pode remover quando quiser) -->
  <script src="quickfix-save.js"></script>
</body>
</html>
