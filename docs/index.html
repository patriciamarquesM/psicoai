<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>PsicoAi ‚Äî Prontu√°rio & An√°lise</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Fonte profissional (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Tema Profissional Clean -->
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- TOPBAR minimalista -->
  <header class="topbar">
    <div class="brand"><h1>PsicoAi</h1></div>
    <input id="searchBox" class="search" placeholder="Buscar paciente..." />
    <button id="themeToggle" class="icon-btn" title="Claro/Escuro">üåì</button>
  </header>

  <!-- LAYOUT 2 COLUNAS -->
  <main class="container">

    <!-- Coluna ESQUERDA ------------------------------------>
    <!-- Configura√ß√µes Cl√≠nicas (pode ficar recolh√≠vel se quiser usar <details>) -->
    <section class="panel left" id="configPanel">
      <h2>Configura√ß√µes Cl√≠nicas</h2>
      <div class="grid">
        <label>Nome do profissional
          <input id="clinicianName" placeholder="ex.: Dra. Maria Silva" />
        </label>
        <label>Registro (CRP/CRM)
          <input id="clinicianReg" placeholder="ex.: CRP 00/00000" />
        </label>
        <label class="full">Chave secreta (assinatura digital HMAC-SHA-256)
          <input id="signatureSecret" type="password" placeholder="Opcional ‚Äî fica s√≥ no seu navegador" />
        </label>
      </div>

      <h3>Campos cl√≠nicos customiz√°veis</h3>
      <div class="row">
        <input id="newFieldLabel" placeholder="ex.: Setting, Interven√ß√µes, Escalas..." />
        <button id="addField" class="btn">Adicionar</button>
      </div>
      <div id="customFieldsList" class="list" style="margin-top:8px"></div>

      <div class="row" style="margin-top:8px">
        <button id="saveSettings" class="btn primary">Salvar</button>
        <button id="resetSettings" class="btn">Restaurar padr√£o</button>
      </div>
      <p class="muted small" style="margin-top:6px">Tudo √© salvo somente no seu navegador (localStorage).</p>
    </section>

    <!-- Cadastro / Edi√ß√£o de paciente -->
    <section class="panel left">
      <h2>Cadastrar / Editar Paciente</h2>
      <form id="patientForm" autocomplete="off">
        <div class="grid">
          <label>Nome <input name="nome" required /></label>
          <label>CPF <input name="cpf" inputmode="numeric" placeholder="000.000.000-00" required /></label>
          <label>Data de nascimento <input name="dob" type="date" required /></label>
          <label>E-mail <input name="email" type="email" required /></label>
          <label class="full">Endere√ßo <input name="endereco" /></label>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" type="submit">Salvar</button>
          <button class="btn" type="reset" id="resetForm">Limpar</button>
          <span class="muted small">O CPF √© armazenado como <em>hash</em>; n√£o guardamos o valor bruto.</span>
        </div>
        <input type="hidden" name="id" />
      </form>
    </section>

    <!-- Lista de pacientes -->
    <section class="panel left">
      <h2>Pacientes</h2>
      <div id="patientList" class="list"></div>
    </section>

    <!-- Coluna DIREITA ------------------------------------>
    <!-- Prontu√°rio + Filtros -->
    <section class="panel right">
      <h2>Prontu√°rio & Transcri√ß√£o</h2>
      <div class="row" style="margin-bottom:6px">
        <label>De: <input id="filterFrom" type="date"></label>
        <label>At√©: <input id="filterTo" type="date"></label>
        <button id="applyFilter" class="btn">Aplicar</button>
        <button id="clearFilter" class="btn">Limpar</button>
        <span style="flex:1"></span>
        <button id="openTranscription" class="btn primary">Nova transcri√ß√£o</button>
      </div>
      <div id="recordView" class="record-view empty">
        <p>Selecione um paciente para visualizar o prontu√°rio.</p>
      </div>
    </section>

    <!-- M√≥dulo Inteligente -->
    <section class="panel right">
      <h2>M√≥dulo Inteligente (Resumo, Teorias)</h2>
      <div id="analysisPanel" class="analysis"></div>
    </section>

    <!-- Insights & Gr√°ficos -->
    <section class="panel right">
      <h2>Insights & Gr√°ficos (per√≠odo aplicado)</h2>
      <div id="chartsPanel">
        <div class="box">
          <strong>Dura√ß√£o total por m√™s (min)</strong>
          <svg id="chartLine" viewBox="0 0 600 220" style="width:100%;height:auto"></svg>
        </div>
        <div class="box" style="margin-top:12px">
          <strong>Termos mais frequentes</strong>
          <svg id="chartBars" viewBox="0 0 600 260" style="width:100%;height:auto"></svg>
        </div>
      </div>
    </section>

    <!-- Backup & Relat√≥rios (largura total) -->
    <section class="panel full">
      <h2>Backup & Relat√≥rios</h2>
      <div class="row">
        <button id="exportJson" class="btn">Exportar JSON</button>
        <button id="exportCsvPatients" class="btn">CSV Pacientes</button>
        <button id="exportCsvRecords" class="btn">CSV Prontu√°rios</button>
        <button id="importJsonBtn" class="btn">Importar JSON</button>
        <input id="importJsonInput" type="file" accept="application/json" style="display:none" />
        <button id="pdfReport" class="btn primary">PDF ‚Äî √öltima Sess√£o</button>
        <button id="pdfReportPeriod" class="btn">PDF ‚Äî Por per√≠odo</button>
      </div>

      <div class="row" style="margin-top:8px">
        <span class="badge">Comparativo A</span>
        <label>De: <input id="compAFrom" type="date"></label>
        <label>At√©: <input id="compATo" type="date"></label>
        <span class="badge">Comparativo B</span>
        <label>De: <input id="compBFrom" type="date"></label>
        <label>At√©: <input id="compBTo" type="date"></label>
        <button id="pdfReportCompare" class="btn">PDF ‚Äî Comparativo</button>
      </div>
    </section>

  </main>

  <!-- MODAL ‚Ä¢ Nova Transcri√ß√£o (mesma estrutura/IDs) -->
  <div id="transcriptionModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <header class="modal-header">
        <h3>Nova Transcri√ß√£o</h3>
        <button class="icon-btn" id="closeModal" aria-label="Fechar">‚úï</button>
      </header>

      <div class="modal-body">
        <div class="tabs" style="margin-bottom:10px">
          <button class="tab active" data-tab="upload">Importar √Åudio</button>
          <button class="tab" data-tab="mic">Transcrever (Microfone)</button>
        </div>

        <!-- Aba: Importar -->
        <div class="tab-panel" data-panel="upload">
          <label class="full">Arquivo de √°udio
            <input id="audioFile" type="file" accept="audio/*,video/mp4,video/m4a,video/*" />
          </label>
          <label class="full">Cole a transcri√ß√£o (opcional)
            <textarea id="pastedTranscript" rows="6" placeholder="Cole a transcri√ß√£o do √°udio, se tiver."></textarea>
          </label>

          <div class="row" style="margin-top:6px; gap:10px; align-items:center">
            <button id="btnTranscribeFile" class="btn">Transcrever arquivo (offline)</button>
            <span id="sttStatus" class="badge">modelo: n√£o carregado</span>

            <!-- Controles opcionais -->
            <label><input id="sttEnhance" type="checkbox" checked> Melhorar √°udio (NR + VAD + AGC)</label>
            <label>Idioma:
              <select id="sttLang">
                <option value="pt" selected>Portugu√™s</option>
                <option value="es">Espanhol</option>
                <option value="en">Ingl√™s</option>
              </select>
            </label>
          </div>
          <p class="muted small" style="margin-top:6px">
            A primeira transcri√ß√£o baixa o modelo Whisper (cache no navegador).
          </p>
        </div>

        <!-- Aba: Microfone -->
        <div class="tab-panel hidden" data-panel="mic">
          <p class="muted">Use o microfone para ditar (Web Speech API em HTTPS).</p>
          <div class="row">
            <button id="startMic" class="btn primary">Iniciar Ditado</button>
            <button id="stopMic" class="btn" disabled>Parar</button>
            <span id="micStatus" class="badge">parado</span>
          </div>
          <textarea id="liveTranscript" rows="8" placeholder="A transcri√ß√£o do microfone aparecer√° aqui..." readonly></textarea>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
        <h3>Metadados da sess√£o</h3>
        <div class="grid">
          <label>Dura√ß√£o (min) <input id="sessDuration" type="number" min="0" step="5" placeholder="ex.: 50" /></label>
          <label>Setting <input id="sessSetting" placeholder="ex.: presencial, remoto, hospitalar..." /></label>
          <label class="full">Interven√ß√µes <input id="sessInterv" placeholder="associa√ß√µes, interpreta√ß√µes, manejo..." /></label>

          <label class="full">CID-10 (c√≥digos, separados por v√≠rgula)
            <input id="sessCID" list="cidList" placeholder="ex.: F32.1, F41.1" />
            <datalist id="cidList"></datalist>
            <div id="cidSugg" class="small muted"></div>
          </label>

          <label class="full">DSM-5 (c√≥digos, separados por v√≠rgula)
            <input id="sessDSM" list="dsmList" placeholder="ex.: 300.02, 296.32" />
            <datalist id="dsmList"></datalist>
            <div id="dsmSugg" class="small muted"></div>
          </label>

          <div class="full"><div id="descSugg" class="small muted"></div></div>
        </div>
        <div id="customFieldsContainer" class="grid" style="margin-top:6px"></div>
      </div>

      <footer class="modal-footer">
        <button id="saveTranscript" class="btn primary">Salvar no Prontu√°rio</button>
        <button id="cancelTranscript" class="btn">Cancelar</button>
      </footer>
    </div>
  </div>

  <!-- ===== Scripts ===== -->
  <!-- Tema claro/escuro persistente -->
  <script>
    (function(){
      const KEY='psicoai_theme';
      const html=document.documentElement;
      html.dataset.theme = localStorage.getItem(KEY) || 'light';
      document.getElementById('themeToggle')?.addEventListener('click', ()=>{
        const next = html.dataset.theme === 'dark' ? 'light' : 'dark';
        html.dataset.theme = next; localStorage.setItem(KEY,next);
      });
    })();
  </script>

  <!-- Transcri√ß√£o offline (com melhoria de √°udio e fallbacks) -->
  <script type="module" src="stt_offline.js?v=6"></script>

  <!-- M√≥dulos do app (mantidos na raiz de docs/) -->
  <script type="module" src="export.js"></script>
  <script type="module" src="report.js"></script>
  <script type="module" src="settings.js"></script>
  <script type="module" src="codes.js"></script>
  <script type="module" src="autocomplete.js"></script>
  <script type="module" src="charts.js"></script>
  <script type="module" src="components.js"></script>
  <script type="module" src="analysis.js"></script>
  <script type="module" src="speech.js"></script>
  <script type="module" src="db.js"></script>
  <script type="module" src="utils.js"></script>
  <script type="module" src="app.js"></script>

  <!-- Quickfix opcional do cadastro (pode remover depois que estiver tudo ok) -->
  <script src="quickfix-save.js"></script>
</body>
</html>
